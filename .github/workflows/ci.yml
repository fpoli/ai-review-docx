name: CI

on:
  workflow_dispatch:
  push:
    branches: [ master ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Set up Python ${{ matrix.python-version }}
      run: uv python install ${{ matrix.python-version }}

    - name: Install dependencies
      run: uv sync

    - name: Basic import test
      run: |
        uv run python -c "import ai_review_docx; print('Package imported successfully')"

    - name: Test CLI help
      run: |
        uv run ai-review-docx --help

    - name: Install Ollama
      run: |
        curl -fsSL https://ollama.com/install.sh | sh

    - name: Start Ollama service
      run: |
        ollama serve &
        sleep 5

    - name: Pull tiny model
      run: |
        ollama pull gemma3:1b

    - name: Test the tool using the tiny model
      run: |
        # Create a simple test document
        uv run python -c "
        from docx import Document
        doc = Document()
        doc.add_paragraph('This is a test document with some text that needs review and corrwections.')
        doc.save('test.docx')
        "
        # Test the CLI with the small model (with timeout to prevent hanging)
        timeout 300 uv run ai-review-docx test.docx --model ollama/gemma3:1b
